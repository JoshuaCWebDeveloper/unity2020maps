<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""/>
<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
	integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
	crossorigin=""></script>

<script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
<link rel="stylesheet" type="text/css" href="css/L.Control.Locate.css"  />
<link rel="stylesheet" type="text/css" href="css/L.Control.Locate.mapbox.css"  />
<script src="js/L.Control.Locate.min.js"></script> 


<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="css/Leaflet.BigImage.min.css" />
<script src="js/Leaflet.BigImage.min.js"></script>

<script src="js/leaflet.browser.print.js"></script>

<script src="map_style.js"></script> 
<script src="js/panel_desktop.js"></script> 

<style>

  #mapid { height: 100%;
           width: 100%}

  #panel {
      width: 300px;
      height: 100%;
      background-color: lightgrey;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
  }
  #container{
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
  }

  #mapcontainer{
      height: 100%;
      width: 100%;
      display: flex;
  }

  .legend
  {
      background-color: lightgrey;
  }
  
  .circle
  {

      height: 10px;
      width: 10px;
      display: inline-block;
      
  }

  .searchBar{
      display: flex;
      flex-direction: row;
  }
  #goBtn
  {
      width: 80px;
      height: 30px;
      font-size: 18px;
      margin: 10px
		  
  }
  #title
  {
      font-size: 35px;
      text-align: center;
  }
  #subtitle
  {
      font-size: 25px;
      text-align: center;
  }

  #guide {
      top: 10px;
      position: relative;
  }
  
  #legend
  {
      top: 50px;
      position: relative;
  }


  .leaflet-control-browser-print {display: none;}
  .leaflet-control-geocoder
  {
      width: 220px;
      font-size: 12px;
      margin: 5px;
  }
  .leaflet-bar
  {
      box-shadow: none;
  }
  
</style>

<div id="container">
  <div id="mapcontainer">
    <div id="panel"></div>
    <div id="mapid"></div>
  </div>
  <div id="footer"></div>
</div>


<script>


  d3.select('#footer').append('a')
    .html("Map tiles by <a href='http://stamen.com'>Stamen Design</a>, under <a href='http://creativecommons.org/licenses/by/3.0'>CC BY 3.0</a>. Data by <a href='http://openstreetmap.org'>OpenStreetMap</a>, under <a href='http://www.openstreetmap.org/copyright'>ODbL</a>.")


  var isMobile = (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1)

  if (isMobile)
  {
      d3.select("#panel").remove()
      L.Map.invalidateSize()
  }
  else
  {
      build_desktop_panel()
  }
  
  // Initialize Map
  // Start view over Washington State, zoomed out
  var map = L.map('mapid').setView([37, -95], 5)
  //map.locate({setView: true})

  var geocoder = L.Control.geocoder({
      //defaultMarkGeocode: false,
      collapsed: false,
      placeholder: "Search..."
      
  })
      .on('markgeocode', function(e) {
	  var bbox = e.geocode.bbox;
	  var poly = L.polygon([
	      bbox.getSouthEast(),
	      bbox.getNorthEast(),
	      bbox.getNorthWest(),
	      bbox.getSouthWest()
	  ])
	  map.fitBounds(poly.getBounds());
      })
      .addTo(map);

  // Print map
  L.control.browserPrint({manualMode: true}).addTo(map)

  // Move leaflet 'control' off the map
  var newParent = document.getElementById('custom-map-controls');
  var oldParent = document.getElementsByClassName("leaflet-top leaflet-right")

  while (oldParent[0].childNodes.length > 0) {
      newParent.appendChild(oldParent[0].childNodes[0]);
  }



  // Add basemap. This can be replaced with an open-source base not from mapbox
  var base_layer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-hybrid/{z}/{x}/{y}.png', {
      attribution: 'Stamen Maps (maps.stamen.com)',
      maxZoom: 18,
      id: 'lines',
      tileSize: 512,
      zoomOffset: -1,
  })

  // Add basemap. This can be replaced with an open-source base not from mapbox
  var base_labels = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {
      attribution: 'Stamen Maps (maps.stamen.com)',
      maxZoom: 18,
      id: 'labels',
      tileSize: 512,
      zoomOffset: -1,
  })
  
  // URL of the AWS server with Tileserver running
  var url = "https://maps443.tcpdump.rocks/data/precentile_precincts/{z}/{x}/{y}.pbf"

  // Add our map
  var unity_map = L.vectorGrid.protobuf(url, {
      maxZoom: 20,
      vectorTileLayerStyles: {
	  interactive: true,
	  percentile_precincts_1: properties => {
	      return getColorFromProperty(properties)
	  }
      },
      // MUST include attribution - where we got this data
      attribution: ' 2016 Precinct-Level Election Results - Harvard Datasource: Voting and Election Science Team, University of Florida and Witchita State University',
      
  })
  
  // Add our layer to the map
  base_layer.addTo(map)
  unity_map.addTo(map)
  base_labels.addTo(map)

  if (isMobile)
  {
      //map.locate({setView: true, maxZoom: 10});  
  }
  


  function onEachFeature(feature, layer) {
      layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: clickFeature
      });
  }
  
  function clickFeature(d)
  {
      console.log(d)
  }

</script>

